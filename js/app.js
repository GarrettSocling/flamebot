// Generated by CoffeeScript 1.8.0
var Announcer, BigCar, ButtonAnnouncer, ButtonWatcher, CrashAnnouncer, LittleCar, LocationAnnouncer, OrientationAnnouncer, RobotBatteryLimit, RobotFindingState, RobotFlaggingState, RobotLoopState, RobotPhotographingState, RobotSequentialState, RobotState, RobotTestMachine, RobotTimeLimit, StateTracker, TimeAnnouncer, bot,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

RobotState = (function() {
  function RobotState(name, goals, listener, entering) {
    this.name = name;
    this.goals = goals;
    this.listener = listener;
    this.entering = entering;
    this.behaviors = [];
    this.parent = null;
    this.addForward = true;
  }

  RobotState.prototype.addChild = function(state) {
    state.parent = this;
    if (this.addForward) {
      this.behaviors.push(state);
    } else {
      this.behaviors.unshift(state);
    }
    return state;
  };

  RobotState.prototype.processEvent = function(currentState, event) {
    var newState;
    if (this.parent) {
      newState = this.parent.processEvent(currentState, event);
    }
    if (!newState) {
      newState = this.listener(currentState, event);
      if (newState) {
        newState.enterAll(currentState, newState);
      }
    }
    return newState;
  };

  RobotState.prototype.enterAll = function(oldState, currentState) {
    if (this.parent) {
      this.parent.enterAll(oldState, currentState);
    }
    if (this.entering) {
      return this.entering(oldState, currentState);
    }
  };

  RobotState.prototype.findHandler = function(goal) {
    return this.ancestor().findHandlerR(goal);
  };

  RobotState.prototype.findHandlerR = function(goal) {
    var behavior, found, _i, _len, _ref;
    if (__indexOf.call(this.goals, goal) >= 0) {
      return this;
    }
    _ref = this.behaviors;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      behavior = _ref[_i];
      found = behavior.findHandlerR(goal);
      if (found) {
        return found;
      }
    }
    return null;
  };

  RobotState.prototype.ancestor = function() {
    if (!this.parent) {
      return this;
    }
    return this.parent.ancestor();
  };

  RobotState.prototype.contains = function(target) {
    var child, _i, _len, _ref;
    if (target === this) {
      return true;
    }
    _ref = this.behaviors;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      child = _ref[_i];
      if (child.contains(target)) {
        return true;
      }
    }
    return false;
  };

  return RobotState;

})();

RobotLoopState = (function(_super) {
  __extends(RobotLoopState, _super);

  function RobotLoopState(name, goals) {
    RobotLoopState.__super__.constructor.call(this, name, goals, function(currentState, event) {
      if (currentState !== this) {
        return null;
      }
      return this.behaviors[0] || this.parent;
    });
  }

  return RobotLoopState;

})(RobotState);

RobotSequentialState = (function(_super) {
  __extends(RobotSequentialState, _super);

  function RobotSequentialState(name, goals) {
    RobotSequentialState.__super__.constructor.call(this, name, goals, function(currentState, event) {
      if (currentState !== this) {
        return null;
      }
      return this.behaviors[this.counter] || this.parent;
    }, (function(_this) {
      return function(oldState, currentState) {
        if (currentState !== _this) {
          return;
        }
        return _this.counter = _this.contains(oldState) ? (_this.counter || -1) + 1 : 0;
      };
    })(this));
  }

  return RobotSequentialState;

})(RobotState);

RobotTimeLimit = (function(_super) {
  __extends(RobotTimeLimit, _super);

  function RobotTimeLimit(name, goals, duration) {
    this.duration = duration;
    this.elapsed = 0;
    RobotTimeLimit.__super__.constructor.call(this, name, goals, function(currentState, event) {
      if (event.timer) {
        console.log("comparing elapsed " + this.elapsed + " with duration " + this.duration);
        this.elapsed += event.timer;
        if (this.elapsed > this.duration) {
          this.elapsed = 0;
          return this.parent;
        }
      }
      if (currentState === this) {
        console.log("limit's child completed; passing back to parent");
        return this.parent;
      }
      return null;
    }, (function(_this) {
      return function(oldState, currentState) {
        if (!_this.contains(oldState)) {
          return _this.elapsed = 0;
        }
      };
    })(this));
  }

  return RobotTimeLimit;

})(RobotState);

RobotFlaggingState = (function(_super) {
  __extends(RobotFlaggingState, _super);

  function RobotFlaggingState(driver, name, goals, target) {
    this.target = target;
    RobotFlaggingState.__super__.constructor.call(this, name, goals, function(currentState, event) {
      var finder;
      if (event.location) {
        finder = this.target.addChild(new RobotFindingState(driver, "flag: " + name, [], event.location.coords));
        console.log(finder);
        return this.parent;
      }
      return null;
    });
  }

  return RobotFlaggingState;

})(RobotState);

RobotPhotographingState = (function(_super) {
  __extends(RobotPhotographingState, _super);

  function RobotPhotographingState(name, goals, filename) {
    RobotPhotographingState.__super__.constructor.call(this, name, goals, function(currentState, event) {
      return this.parent;
    }, (function(_this) {
      return function(oldState, currentState) {
        var options;
        if (currentState !== _this) {
          return;
        }
        options = {
          camera: navigator.mozCameras.getListOfCameras()[0]
        };
        return naigator.mozCameras.getCamera(options, function(camera) {
          var poptions;
          poptions = {
            rotation: 90,
            pictureSize: camera.capabilities.pictureSizes[0],
            fileFormat: camera.capabilities.fileFormats[0]
          };
          return camera.takePicture(poptions, function(blob) {
            return navigator.getDeviceStorage('pictures').addNamed(blob, filename);
          });
        });
      };
    })(this));
  }

  return RobotPhotographingState;

})(RobotState);

RobotFindingState = (function(_super) {
  __extends(RobotFindingState, _super);

  function RobotFindingState(driver, name, goals, location, perimeter, compass_variance) {
    this.driver = driver;
    this.location = location;
    this.perimeter = perimeter != null ? perimeter : 1;
    this.compass_variance = compass_variance != null ? compass_variance : 20;
    console.log("creating a findingstate with location");
    console.log(this.location);
    RobotFindingState.__super__.constructor.call(this, name, goals, function(currentState, event) {
      var d, newState;
      if (event.location) {
        this.current_location = event.location.coords;
        if (this.distance(this.current_location, this.location) < this.perimeter) {
          return this.parent;
        }
      }
      if (event.orientation) {
        this.compass_reading = event.orientation.alpha;
      }
      newState = this;
      d = this.correction();
      if (d > this.compass_variance) {
        newState = this.left_turning;
      }
      if (d < -this.compass_variance) {
        newState = this.right_turning;
      }
      if (currentState === newState) {
        return null;
      }
      return newState;
    }, (function(_this) {
      return function(oldState, currentState) {
        if (currentState !== _this) {
          return;
        }
        return _this.driver.drive(1);
      };
    })(this));
    this.left_turning = this.addChild(new RobotState("" + this.name + ": left-turn", ["left-turn"], function(currentState, event) {
      return null;
    }, (function(_this) {
      return function(oldState, currentState) {
        if (currentState !== _this) {
          return;
        }
        return _this.driver.drive(5);
      };
    })(this)));
    this.right_turning = this.addChild(new RobotState("" + this.name + ": right-turn", ["right-turn"], function(currentState, event) {
      return null;
    }, (function(_this) {
      return function(oldState, currentState) {
        if (currentState !== _this) {
          return;
        }
        return _this.driver.drive(6);
      };
    })(this)));
  }

  RobotFindingState.prototype.toRadians = function(r) {
    return r * Math.PI / 180.0;
  };

  RobotFindingState.prototype.toDegrees = function(d) {
    return 180.0 * d / Math.PI;
  };

  RobotFindingState.prototype.correction = function() {
    var bearing;
    if (!this.compass_reading) {
      return 0;
    }
    if (!this.current_location) {
      return 0;
    }
    bearing = this.bearing(this.location, this.current_location);
    return ((360 + this.compass_reading - bearing) % 360) - 180;
  };

  RobotFindingState.prototype.bearing = function(a, b) {
    var lat1, lat2, lon1, lon2, x, y;
    lat1 = this.toRadians(a.latitude);
    lat2 = this.toRadians(b.latitude);
    lon1 = this.toRadians(a.longitude);
    lon2 = this.toRadians(b.longitude);
    y = Math.sin(lon2 - lon1) * Math.cos(lat2);
    x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
    return this.toDegrees(Math.atan2(y, x));
  };

  RobotFindingState.prototype.distance = function(a, b, r) {
    var d, lat1, lat2, lon1, lon2, n;
    if (r == null) {
      r = 6371000;
    }
    lat1 = this.toRadians(a.latitude);
    lat2 = this.toRadians(b.latitude);
    lon1 = this.toRadians(a.longitude);
    lon2 = this.toRadians(b.longitude);
    n = (Math.pow(Math.sin((lat2 - lat1) / 2), 2)) + Math.cos(lat1) * Math.cos(lat2) * (Math.pow(Math.sin((lon2 - lon1) / 2), 2));
    d = 2 * r * Math.atan2(Math.sqrt(n), Math.sqrt(1 - n));
    return d;
  };

  return RobotFindingState;

})(RobotState);

RobotBatteryLimit = (function(_super) {
  __extends(RobotBatteryLimit, _super);

  function RobotBatteryLimit(name, goals, threshold) {
    this.threshold = threshold;
    RobotBatteryLimit.__super__.constructor.call(this, name, goals, function(currentState, event) {
      if (event.battery && event.battery < this.threshold) {
        return this.parent;
      }
      return null;
    });
  }

  return RobotBatteryLimit;

})(RobotState);

ButtonWatcher = (function(_super) {
  __extends(ButtonWatcher, _super);

  function ButtonWatcher(name, goals, entering) {
    ButtonWatcher.__super__.constructor.call(this, name, goals, function(currentState, event) {
      if (event.button) {
        return currentState.findHandler(event.button);
      }
      if (event.battery) {
        console.log("battery is now " + event.battery);
      }
      return null;
    }, entering);
  }

  return ButtonWatcher;

})(RobotState);

StateTracker = (function() {
  function StateTracker() {}

  StateTracker.prototype.setState = function(state) {
    this.state = state;
    this.state.enterAll(null, this.state);
    return this.showState();
  };

  StateTracker.prototype.announce = function(event) {
    var newState;
    if (!this.state) {
      return;
    }
    newState = this.state.processEvent(this.state, event);
    if (newState) {
      this.state = newState;
      return this.showState();
    }
  };

  StateTracker.prototype.showState = function() {
    return console.log("entered state " + this.state.name);
  };

  return StateTracker;

})();

LittleCar = (function() {
  function LittleCar(bot) {
    this.bot = bot;
    $.ajaxSetup({
      xhr: function() {
        return new window.XMLHttpRequest({
          mozSystem: true
        });
      }
    });
  }

  LittleCar.prototype.drive = function(code, speed) {
    if (speed == null) {
      speed = 8;
    }
    return $.ajax('http://localhost:8080/' + code + speed.toString(16), {
      type: 'GET',
      dataType: 'html',
      success: (function(_this) {
        return function(data) {
          return _this.bot.announce({
            battery: data
          });
        };
      })(this)
    });
  };

  return LittleCar;

})();

BigCar = (function() {
  function BigCar(bot, pace, address, port) {
    this.bot = bot;
    this.pace = pace != null ? pace : 250;
    this.address = address != null ? address : "192.168.2.3";
    this.port = port != null ? port : 9000;
    this.connecting = false;
    this.connectSocket();
    this.code = 0;
    window.setInterval(((function(_this) {
      return function() {
        return _this.nextCode();
      };
    })(this)), this.pace);
  }

  BigCar.prototype.connectSocket = function() {
    if (this.connecting) {
      return;
    }
    this.connecting = true;
    this.socket = navigator.mozTCPSocket.open(this.address, this.port);
    this.socket.onopen = (function(_this) {
      return function() {
        return _this.connecting = false;
      };
    })(this);
    this.socket.onerror = (function(_this) {
      return function() {
        return _this.connecting = false;
      };
    })(this);
    this.socket.onclose = (function(_this) {
      return function() {
        return _this.connecting = false;
      };
    })(this);
    return this.socket.ondata = (function(_this) {
      return function(event) {
        var level;
        level = (parseInt(event.data.slice(2), 16) - 2655) * 0.20;
        return _this.bot.announce({
          battery: level
        });
      };
    })(this);
  };

  BigCar.prototype.drive = function(code) {
    this.code = code;
  };

  BigCar.prototype.code2command = function(code) {
    var newCode;
    newCode = "05893476"[code - 1];
    if (newCode) {
      return "$" + newCode + "9476$?";
    }
    return "$?";
  };

  BigCar.prototype.nextCode = function() {
    if (this.socket.readyState === "open") {
      if (this.code > -5) {
        this.socket.send(this.code2command(this.code));
        if (this.code < 1) {
          return this.code -= 1;
        }
      }
    } else {
      return this.connectSocket();
    }
  };

  return BigCar;

})();

Announcer = (function() {
  function Announcer(name, bot) {
    this.name = name;
    this.bot = bot;
    console.log("tracking " + this.name + " events");
  }

  return Announcer;

})();

ButtonAnnouncer = (function(_super) {
  __extends(ButtonAnnouncer, _super);

  function ButtonAnnouncer(name, bot, buttons) {
    var action, _fn, _i, _len;
    ButtonAnnouncer.__super__.constructor.call(this, name, bot);
    _fn = function(action) {
      return $("#" + action + "-button").click((function(_this) {
        return function() {
          return _this.bot.announce({
            button: action
          });
        };
      })(this));
    };
    for (_i = 0, _len = buttons.length; _i < _len; _i++) {
      action = buttons[_i];
      _fn(action);
    }
  }

  return ButtonAnnouncer;

})(Announcer);

CrashAnnouncer = (function(_super) {
  __extends(CrashAnnouncer, _super);

  function CrashAnnouncer(name, bot, magnitude, mininterval) {
    this.magnitude = magnitude != null ? magnitude : 25;
    this.mininterval = mininterval != null ? mininterval : 1000000;
    CrashAnnouncer.__super__.constructor.call(this, name, bot);
    this.motionTimeStamp = 0;
    this.motionVector = {
      x: 0,
      y: 0,
      z: 0
    };
    this.crash_id = window.addEventListener('devicemotion', (function(_this) {
      return function(event) {
        var a, interval, m, v;
        a = event.accelerationIncludingGravity;
        m = _this.motionVector;
        v = Math.pow(a.x - m.x, 2) + Math.pow(a.y - m.y, 2) + Math.pow(a.z - m.z, 2);
        interval = event.timeStamp - _this.motionTimeStamp;
        _this.motionVector = {
          x: a.x,
          y: a.y,
          z: a.z
        };
        if (v > _this.magnitude && interval > _this.mininterval) {
          console.log("motion event magnitude " + v + " after " + (interval / _this.mininterval) + " intervals");
          _this.bot.announce({
            crash: event
          });
          return _this.motionTimeStamp = event.timeStamp;
        }
      };
    })(this));
  }

  return CrashAnnouncer;

})(Announcer);

OrientationAnnouncer = (function(_super) {
  __extends(OrientationAnnouncer, _super);

  function OrientationAnnouncer(name, bot) {
    OrientationAnnouncer.__super__.constructor.call(this, name, bot);
    this.orientation_id = window.addEventListener('deviceorientation', (function(_this) {
      return function(event) {
        return _this.bot.announce({
          orientation: event
        });
      };
    })(this), true);
  }

  return OrientationAnnouncer;

})(Announcer);

LocationAnnouncer = (function(_super) {
  __extends(LocationAnnouncer, _super);

  function LocationAnnouncer(name, bot) {
    LocationAnnouncer.__super__.constructor.call(this, name, bot);
    this.watch_id = navigator.geolocation.watchPosition((function(_this) {
      return function(location) {
        return _this.bot.announce({
          location: location
        }, function() {
          return console.log("geolocation error", {
            enableHighAccuracy: true
          });
        });
      };
    })(this));
  }

  return LocationAnnouncer;

})(Announcer);

TimeAnnouncer = (function(_super) {
  __extends(TimeAnnouncer, _super);

  function TimeAnnouncer(name, bot) {
    TimeAnnouncer.__super__.constructor.call(this, name, bot);
    this.interval_id = window.setInterval(((function(_this) {
      return function() {
        return _this.bot.announce({
          timer: 1
        });
      };
    })(this)), 1000);
  }

  return TimeAnnouncer;

})(Announcer);

RobotTestMachine = (function(_super) {
  __extends(RobotTestMachine, _super);

  function RobotTestMachine(driver) {
    this.driver = driver;
    RobotTestMachine.__super__.constructor.call(this, "waiting", ["stop"], (function(_this) {
      return function() {
        return _this.driver.drive(0);
      };
    })(this));
    this.limited = this.addChild(new RobotTimeLimit("limiting", [], 180));
    this.sequence = this.limited.addChild(new RobotSequentialState("stepping", ["go"]));
    this.sequence.addForward = false;
    this.limited.addChild(new RobotFlaggingState(this.driver, "storing", ["store"], this.sequence));
    this.limited.addChild(new RobotState("driving", ["drive"], (function() {
      return null;
    }), ((function(_this) {
      return function() {
        return _this.driver.drive(1);
      };
    })(this))));
    this.addChild(new RobotState("resetting", ["reset"], (function(_this) {
      return function(currentState, event) {
        return new RobotTestMachine(_this.driver);
      };
    })(this)));
  }

  return RobotTestMachine;

})(ButtonWatcher);

bot = new StateTracker();

$(function() {
  bot.setState(new RobotTestMachine(new BigCar(bot)));
  new ButtonAnnouncer("button", bot, ["go", "stop", "store", "reset", "drive"]);
  new CrashAnnouncer("crash", bot);
  new OrientationAnnouncer("orientation", bot);
  new LocationAnnouncer("location", bot);
  return new TimeAnnouncer("time", bot);
});
